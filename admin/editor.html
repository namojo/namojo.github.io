<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jekyll Blog Editor - Advanced</title>
    <!-- SimpleMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .sidebar-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .btn-new {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-new:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .post-list {
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }
        
        .post-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .post-item:hover {
            background: #f8f9fa;
        }
        
        .post-item.active {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
        }
        
        .post-item-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .post-item-date {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Editor Section */
        .editor-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .editor-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-size: 13px;
            color: #495057;
            font-weight: 600;
        }
        
        .form-control {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        /* Tags Input */
        .tags-input-container {
            position: relative;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            min-height: 40px;
            align-items: center;
        }
        
        .tags-input:focus-within {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .tag {
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .tag-input-field {
            border: none;
            outline: none;
            flex-grow: 1;
            min-width: 100px;
            font-size: 14px;
        }
        
        /* Editor Container */
        .editor-container {
            padding: 20px;
        }
        
        /* SimpleMDE Customization */
        .editor-preview-side {
            padding: 20px;
        }
        
        .CodeMirror {
            height: calc(100vh - 400px);
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        }
        
        /* Toolbar */
        .toolbar {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .toast.success {
            border-left: 4px solid #28a745;
        }
        
        .toast.error {
            border-left: 4px solid #dc3545;
        }
        
        .toast.info {
            border-left: 4px solid #17a2b8;
        }
        
        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .toast-title {
            font-weight: 600;
        }
        
        .toast-close {
            cursor: pointer;
            opacity: 0.5;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        /* Image Upload Zone */
        .image-upload-zone {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload-zone:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .image-upload-zone.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        #imageFile {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-pen-fancy"></i> Jekyll Blog Editor</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <button class="btn-new" onclick="createNewPost()">
                        <i class="fas fa-plus"></i> 새 포스트
                    </button>
                </div>
                <div class="post-list" id="postList">
                    <!-- Posts will be loaded here -->
                </div>
            </aside>
            
            <!-- Editor Section -->
            <section class="editor-section">
                <div class="editor-header">
                    <div class="metadata-grid">
                        <div class="form-group">
                            <label for="postTitle">제목</label>
                            <input type="text" id="postTitle" class="form-control" placeholder="포스트 제목을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label for="postDate">날짜</label>
                            <input type="date" id="postDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="postLayout">레이아웃</label>
                            <select id="postLayout" class="form-control">
                                <option value="post">post</option>
                                <option value="page">page</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="postImage">대표 이미지</label>
                            <input type="text" id="postImage" class="form-control" placeholder="이미지 파일명">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>태그</label>
                        <div class="tags-input-container">
                            <div class="tags-input" id="tagsContainer">
                                <input type="text" class="tag-input-field" id="tagInput" placeholder="태그 입력 후 Enter">
                            </div>
                        </div>
                    </div>
                    <div class="image-upload-zone" onclick="document.getElementById('imageFile').click()" 
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="color: #6c757d; margin-bottom: 10px;"></i>
                        <p>이미지를 드래그하거나 클릭하여 업로드</p>
                        <input type="file" id="imageFile" accept="image/*" multiple onchange="uploadImages(this.files)">
                    </div>
                </div>
                
                <div class="editor-container">
                    <textarea id="editor"></textarea>
                </div>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="savePost()">
                        <i class="fas fa-save"></i> 저장
                    </button>
                    <button class="btn btn-secondary" onclick="downloadPost()">
                        <i class="fas fa-download"></i> 다운로드
                    </button>
                    <button class="btn btn-danger" onclick="deletePost()" id="deleteBtn" style="display: none;">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-header">
            <span class="toast-title"></span>
            <span class="toast-close" onclick="hideToast()">&times;</span>
        </div>
        <div class="toast-body"></div>
    </div>
    
    <!-- SimpleMDE JS -->
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script>
        // GitHub API configuration
        const GITHUB_OWNER = 'namojo';
        const GITHUB_REPO = 'namojo.github.io';
        const GITHUB_BRANCH = 'master';
        
        // SimpleMDE Editor
        let simplemde;
        let currentPost = null;
        let posts = [];
        let tags = [];
        let uploadedImages = new Map(); // Store uploaded image mappings
        
        // Initialize editor
        function initEditor() {
            simplemde = new SimpleMDE({
                element: document.getElementById("editor"),
                spellChecker: false,
                autosave: {
                    enabled: true,
                    uniqueId: "jekyll-blog-editor",
                    delay: 1000,
                },
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true,
                },
                previewRender: function(plainText) {
                    // Custom preview render to handle local images
                    let html = this.parent.markdown(plainText);
                    
                    // Replace image paths with data URLs if available
                    uploadedImages.forEach((dataUrl, filename) => {
                        const patterns = [
                            new RegExp(`\\(/assets/img/posts/${filename}\\)`, 'g'),
                            new RegExp(`src="/assets/img/posts/${filename}"`, 'g')
                        ];
                        patterns.forEach(pattern => {
                            html = html.replace(pattern, match => {
                                return match.replace(`/assets/img/posts/${filename}`, dataUrl);
                            });
                        });
                    });
                    
                    return html;
                },
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "table", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                status: ["autosave", "lines", "words", "cursor"],
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            loadPosts();
            
            // Set today's date
            document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
            
            // Tag input handling
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });
        });
        
        // Load posts from GitHub
        async function loadPosts() {
            showLoading(true);
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/_posts`);
                const files = await response.json();
                
                posts = files.filter(file => file.name.endsWith('.md') || file.name.endsWith('.markdown'));
                posts.sort((a, b) => b.name.localeCompare(a.name)); // Sort by date (newest first)
                
                renderPostList();
                showToast('success', '포스트 목록을 불러왔습니다.');
            } catch (error) {
                showToast('error', '포스트 목록을 불러오는데 실패했습니다.');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // Render post list in sidebar
        function renderPostList() {
            const postList = document.getElementById('postList');
            postList.innerHTML = '';
            
            posts.forEach((post, index) => {
                const item = document.createElement('div');
                item.className = 'post-item';
                item.setAttribute('data-index', index);
                item.onclick = function() { loadPost(post, this); };
                
                const dateMatch = post.name.match(/^(\d{4}-\d{2}-\d{2})/);
                const date = dateMatch ? dateMatch[1] : '';
                const title = post.name.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/\.(md|markdown)$/, '').replace(/-/g, ' ');
                
                item.innerHTML = `
                    <div class="post-item-title">${title}</div>
                    <div class="post-item-date">${date}</div>
                `;
                
                postList.appendChild(item);
            });
        }
        
        // Load a specific post
        async function loadPost(post, element) {
            showLoading(true);
            try {
                const response = await fetch(post.download_url);
                const content = await response.text();
                
                currentPost = post;
                
                // Parse front matter
                const frontMatterMatch = content.match(/^---\s*\n([\s\S]*?)\n---/);
                if (frontMatterMatch) {
                    const frontMatter = frontMatterMatch[1];
                    const mainContent = content.replace(frontMatterMatch[0], '').trim();
                    
                    // Parse front matter fields
                    const titleMatch = frontMatter.match(/title:\s*(.+)/);
                    const dateMatch = frontMatter.match(/date:\s*(\d{4}-\d{2}-\d{2})/);
                    const layoutMatch = frontMatter.match(/layout:\s*(.+)/);
                    const imgMatch = frontMatter.match(/img:\s*(.+)/);
                    const tagsMatch = frontMatter.match(/tags:\s*\n((?:\s*-\s*.+\n?)*)/);
                    
                    // Set form values
                    document.getElementById('postTitle').value = titleMatch ? titleMatch[1] : '';
                    document.getElementById('postDate').value = dateMatch ? dateMatch[1] : '';
                    document.getElementById('postLayout').value = layoutMatch ? layoutMatch[1] : 'post';
                    document.getElementById('postImage').value = imgMatch ? imgMatch[1] : '';
                    
                    // Parse and set tags
                    tags = [];
                    if (tagsMatch) {
                        const tagLines = tagsMatch[1].match(/\s*-\s*(.+)/g);
                        if (tagLines) {
                            tags = tagLines.map(line => line.replace(/\s*-\s*/, '').trim());
                        }
                    }
                    renderTags();
                    
                    // Set editor content
                    simplemde.value(mainContent);
                }
                
                // Update UI
                document.getElementById('deleteBtn').style.display = 'inline-flex';
                document.querySelectorAll('.post-item').forEach(item => item.classList.remove('active'));
                element.classList.add('active');
                
                showToast('success', '포스트를 불러왔습니다.');
            } catch (error) {
                showToast('error', '포스트를 불러오는데 실패했습니다.');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // Create new post
        function createNewPost() {
            currentPost = null;
            document.getElementById('postTitle').value = '';
            document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('postLayout').value = 'post';
            document.getElementById('postImage').value = '';
            tags = [];
            renderTags();
            simplemde.value('');
            document.getElementById('deleteBtn').style.display = 'none';
            document.querySelectorAll('.post-item').forEach(item => item.classList.remove('active'));
            
            showToast('info', '새 포스트를 작성하세요.');
        }
        
        // Tag management
        function addTag(tag) {
            if (!tags.includes(tag)) {
                tags.push(tag);
                renderTags();
            }
        }
        
        function removeTag(tag) {
            const index = tags.indexOf(tag);
            if (index > -1) {
                tags.splice(index, 1);
                renderTags();
            }
        }
        
        function renderTags() {
            const container = document.getElementById('tagsContainer');
            const input = document.getElementById('tagInput');
            
            // Remove existing tags
            container.querySelectorAll('.tag').forEach(tag => tag.remove());
            
            // Add tags
            tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>`;
                container.insertBefore(tagEl, input);
            });
        }
        
        // Image handling
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                uploadImages(e.dataTransfer.files);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }
        
        async function uploadImages(files) {
            try {
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            try {
                                const dataUrl = e.target.result;
                                const imagePath = `/assets/img/posts/${file.name}`;
                                
                                // Store the data URL for preview
                                uploadedImages.set(file.name, dataUrl);
                                
                                // Insert markdown
                                const imageMarkdown = `![${file.name}](${imagePath})`;
                                const cm = simplemde.codemirror;
                                cm.replaceSelection(imageMarkdown);
                                
                                // Refresh preview
                                if (simplemde.isPreviewActive()) {
                                    simplemde.togglePreview();
                                    setTimeout(() => simplemde.togglePreview(), 100);
                                }
                                
                                showToast('info', `이미지 '${file.name}'가 추가되었습니다. 실제 업로드는 GitHub에 직접 해주세요.`);
                            } catch (error) {
                                console.error('Error processing image:', error);
                                showToast('error', '이미지 처리 중 오류가 발생했습니다.');
                            }
                        };
                        
                        reader.onerror = function() {
                            showToast('error', `이미지 '${file.name}' 읽기 실패`);
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
            } catch (error) {
                console.error('Error uploading images:', error);
                showToast('error', '이미지 업로드 중 오류가 발생했습니다.');
            }
        }
        
        // Generate front matter
        function generateFrontMatter() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            const layout = document.getElementById('postLayout').value;
            const image = document.getElementById('postImage').value;
            
            let frontMatter = '---\n';
            frontMatter += `layout: ${layout}\n`;
            frontMatter += `title: ${title}\n`;
            frontMatter += `date: ${date}\n`;
            frontMatter += `description:\n`;
            if (image) {
                frontMatter += `img: ${image}\n`;
            }
            if (tags.length > 0) {
                frontMatter += `tags:\n`;
                tags.forEach(tag => {
                    frontMatter += `  - ${tag}\n`;
                });
            }
            frontMatter += `comments: true\n`;
            frontMatter += '---\n';
            
            return frontMatter;
        }
        
        // Save post
        function savePost() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            
            if (!title || !date) {
                showToast('error', '제목과 날짜를 입력해주세요.');
                return;
            }
            
            showToast('info', '포스트 저장 기능은 GitHub API 토큰이 필요합니다. 다운로드 후 수동으로 업로드해주세요.');
            downloadPost();
        }
        
        // Download post
        function downloadPost() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            
            if (!title || !date) {
                showToast('error', '제목과 날짜를 입력해주세요.');
                return;
            }
            
            const content = simplemde.value();
            const frontMatter = generateFrontMatter();
            const fullContent = frontMatter + '\n' + content;
            
            // Generate filename
            const slug = title.toLowerCase()
                .replace(/[^\w\s가-힣]/g, '')
                .replace(/\s+/g, '-');
            const filename = `${date}-${slug}.md`;
            
            // Download
            const blob = new Blob([fullContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            showToast('success', '포스트가 다운로드되었습니다.');
        }
        
        // Delete post
        function deletePost() {
            if (!currentPost) return;
            
            if (confirm('정말로 이 포스트를 삭제하시겠습니까?')) {
                showToast('info', '포스트 삭제는 GitHub에서 직접 해주세요.');
            }
        }
        
        // UI Helpers
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const title = type === 'success' ? '성공' : type === 'error' ? '오류' : '알림';
            
            toast.className = `toast ${type}`;
            toast.querySelector('.toast-title').textContent = title;
            toast.querySelector('.toast-body').textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                hideToast();
            }, 3000);
        }
        
        function hideToast() {
            document.getElementById('toast').style.display = 'none';
        }
        
        // Make removeTag function available globally
        window.removeTag = removeTag;
    </script>
</body>
</html>